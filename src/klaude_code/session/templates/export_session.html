<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>$first_user_message - Klaude Code</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%233c6f9f%22 stroke-width=%222%22 stroke-linecap=%22round%22 stroke-linejoin=%22round%22><polyline points=%2216 18 22 12 16 6%22></polyline><polyline points=%228 6 2 12 8 18%22></polyline></svg>"
    />
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@100..900&display=swap" rel="stylesheet" />
    <style>
      :root {
        --bg-body: #f0ede9;
        --bg-container: #f5f3f1;
        --bg-card: #faf8f6;
        --bg-overlay: rgba(241, 239, 238, 0.98);
        --bg-error: #fdecec;
        --bg-success: #eaf6ed;
        --bg-error-strong: #f9d6d6;
        --bg-success-strong: #d5efdd;
        --bg-code: #fdfcfa;
        --border: #e0dcd8;
        --text: #151515;
        --text-dim: #5f6b7a;
        --accent: #3c6f9f;
        --accent-dim: rgba(60, 111, 159, 0.10);
        --accent-underline: rgba(60, 111, 159, 0.25);
        --accent-hover: rgba(60, 111, 159, 0.08);
        --success: #1a7f37;
        --error: #c62828;
        --fg-inline-code: #2f5f8f;
        --user-bg: #f5f8fc;
        --user-border: #dde6f2;
        --assistant-bg: #f7f5f3;
        --assistant-border: #e6e1dc;
        --assistant-text: #3b3b3b;
        --tool-color: #2b7a78;
        --bg-tool: #e6eee7;
        --bg-tool-args: #eef3ef;
        --border-tool: #d6ddd8;
        --font-sans: "Geist Mono", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        --font-mono: "Geist Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        --font-markdown-mono: var(--font-mono);
        --font-markdown: var(--font-sans);
        --font-weight-normal: 400;
        --font-weight-medium: 500;
        --font-weight-bold: 600;
        --font-size-sm: 13px;
        --font-size-base: 14px;
        --font-size-lg: 16px;
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 12px;
        --spacing-lg: 16px;
        --spacing-xl: 24px;
        --radius-sm: 6px;
        --radius-md: 6px;
        --radius-lg: 6px;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        scrollbar-width: thin;
        scrollbar-color: var(--border) var(--bg-container);
      }

      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: var(--bg-container);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 6px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-dim);
      }

      body {
        background-color: var(--bg-body);
        color: var(--text);
        font-family: var(--font-sans);
        line-height: 1.4;
        font-size: var(--font-size-base);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 24px;
      }

      /* Header */
      .header {
        margin-bottom: 24px;
        padding: 16px 20px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--bg-card);
        box-shadow: var(--shadow-sm);
      }

      .header h1 {
        font-size: 18px;
        font-weight: var(--font-weight-bold);
        margin-bottom: 12px;
        color: var(--text);
        display: inline-block;
        font-family: var(--font-mono);
      }

      .meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
      }

      .meta-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .meta-label {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-bold);
        text-transform: lowercase;
        color: var(--text-dim);
        font-family: var(--font-mono);
      }

      .meta-value {
        font-family: var(--font-mono);
        font-size: var(--font-size-sm);
        color: var(--text);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* Components - Collapsible sections */
      details.collapsible-section {
        background: var(--bg-card);
        margin-bottom: 8px;
        border: 1px solid var(--border);
        border-radius: 6px;
        overflow: hidden;
      }

      details.collapsible-section:last-of-type {
        margin-bottom: 16px;
      }

      details.collapsible-section > summary {
        padding: 10px 14px;
        font-family: var(--font-mono);
        font-size: var(--font-size-sm);
        text-transform: lowercase;
        font-weight: var(--font-weight-bold);
        cursor: pointer;
        user-select: none;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 8px;
        min-height: 24px;
        line-height: 1.2;
        color: var(--text-dim);
        transition: color 0.2s, background 0.2s;
        background: var(--bg-card);
      }

      details.collapsible-section > summary:hover,
      details.collapsible-section[open] > summary {
        color: var(--text);
      }

      details.collapsible-section > summary::-webkit-details-marker {
        display: none;
      }
      details.collapsible-section > summary::before {
        content: "▶";
        font-size: 0.8em;
        position: relative;
        top: -1px;
        color: var(--accent);
        font-family: var(--font-mono);
        display: inline-block;
        width: 16px;
        text-align: center;
      }
      details.collapsible-section[open] > summary::before {
        content: "▼";
      }

      details.collapsible-section > .details-content {
        padding: 12px 16px 16px 16px;
        font-size: var(--font-size-sm);
        color: var(--text-dim);
        overflow-x: auto;
        border-top: 1px solid var(--border);
      }

      /* Messages */
      .message-stream {
        display: block;
      }

      .message-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 16px;
      }

      .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
      }

      .message-header .role-label {
        margin-bottom: 0;
      }

      .role-label {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-bold);
        text-transform: lowercase;
        margin-bottom: 4px;
        color: var(--text-dim);
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        font-family: var(--font-mono);
      }
      .message-header .role-label {
        width: auto;
      }
      .role-label.user {
        color: var(--accent);
      }
      .role-label.assistant {
        color: var(--assistant-text);
      }
      .role-label.system {
        color: var(--text-dim);
      }
      .role-label.tool {
        color: var(--tool-color);
      }

      details.developer-message {
        background: var(--bg-card);
        margin-bottom: 8px;
        border: 1px solid var(--border);
        border-radius: 6px;
        overflow: hidden;
      }

      details.developer-message > summary {
        padding: 10px 14px;
        font-family: var(--font-mono);
        font-size: var(--font-size-sm);
        text-transform: lowercase;
        font-weight: var(--font-weight-bold);
        cursor: pointer;
        user-select: none;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 8px;
        min-height: 24px;
        line-height: 1.2;
        color: var(--text-dim);
        transition: color 0.2s, background 0.2s;
        background: var(--bg-container);
      }

      details.developer-message > summary:hover,
      details.developer-message[open] > summary {
        color: var(--text);
      }

      details.developer-message > summary::-webkit-details-marker {
        display: none;
      }
      details.developer-message > summary::before {
        content: "▶";
        font-size: 0.8em;
        
        color: var(--accent);
        font-family: var(--font-mono);
        display: inline-block;
        width: 16px;
        text-align: center;
      }
      details.developer-message[open] > summary::before {
        content: "▼";
      }

      details.developer-message > .details-content {
        padding: 12px 16px 16px 16px;
        font-size: var(--font-size-sm);
        color: var(--text-dim);
        overflow-x: auto;
        border-top: 1px solid var(--border);
      }

      details.developer-message.gap-below {
        margin-bottom: 16px;
      }

      .message-content {
        background: var(--bg-code);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 12px 20px;
        box-shadow: var(--shadow-sm);
        transition: box-shadow 0.2s ease;
        font-size: var(--font-size-base);
        --mask-bg: var(--bg-code);
      }
      .assistant-message {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .assistant-toolbar {
        display: flex;
        justify-content: flex-end;
        align-items: center;
      }
      .raw-toggle {
        border: 1px solid var(--border);
        background: var(--bg-card);
        color: var(--text-dim);
        font-family: var(--font-mono);
        font-size: var(--font-size-sm);
        text-transform: lowercase;
        padding: 2px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: color 0.2s, border-color 0.2s, background 0.2s;
        font-weight: var(--font-weight-bold);
      }
      .raw-toggle:hover {
        color: var(--text);
        border-color: var(--accent);
      }
      .raw-toggle.active {
        color: var(--accent);
        border-color: var(--accent);
        background: var(--accent-dim);
      }

      .copy-raw-btn {
        margin-left: 8px;
        border: 1px solid var(--border);
        background: var(--bg-card);
        color: var(--text-dim);
        font-family: var(--font-mono);
        font-size: var(--font-size-sm);
        text-transform: lowercase;
        padding: 2px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: color 0.2s, border-color 0.2s, background 0.2s;
        font-weight: var(--font-weight-bold);
      }
      .copy-raw-btn:hover {
        color: var(--text);
        border-color: var(--accent);
      }

      .assistant-rendered {
        width: 100%;
      }
      .assistant-raw {
        display: none;
        font-family: var(--font-mono);
        font-size: var(--font-size-base);
        white-space: pre-wrap;
        background: var(--bg-code);
        border: 1px dashed var(--border);
        border-radius: 6px;
        padding: 12px 16px;
      }
      .assistant-message.show-raw .assistant-rendered {
        display: none;
      }
      .assistant-message.show-raw .assistant-raw {
        display: block;
      }

      .message-content.user {
        background: var(--user-bg);
        border: 1px solid var(--user-border);
        color: var(--accent);
        font-family: var(--font-markdown);
        box-shadow: var(--shadow-sm);
        border-bottom-right-radius: 6px;
        --mask-bg: var(--user-bg);
      }

      .message-content.assistant-message {
        background: var(--assistant-bg);
        border-color: var(--assistant-border);
        color: var(--assistant-text);
        --mask-bg: var(--assistant-bg);
        border-bottom-left-radius: 6px;
      }

      .thinking-block {
        margin-top: 8px;
        margin-bottom: 16px;
        padding: 12px 16px;
        border-left: 2px solid var(--assistant-border);
        color: var(--text-dim);
        font-style: italic;
        font-size: var(--font-size-sm);
        background: var(--bg-card);
      }
      .thinking-block.markdown-body p {
        margin-bottom: 8px;
      }
      .thinking-block.markdown-body p:last-child {
        margin-bottom: 0;
      }

      /* Response Metadata */
      .response-metadata {
        margin: 8px 0 16px 0;
        padding: 8px 12px;
        font-family: var(--font-mono);
        font-size: var(--font-size-sm);
        color: var(--text-dim);
        border-left: 2px solid var(--border);
        background: var(--bg-card);
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .metadata-line {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
        line-height: 1.4;
      }
      .metadata-model {
        font-weight: var(--font-weight-bold);
        color: var(--text);
      }
      .metadata-provider {
        opacity: 0.8;
      }
      .metadata-stat {
        white-space: nowrap;
      }
      .metadata-divider {
        color: var(--border);
        margin: 0 2px;
      }

      /* Tool Calls */
      .tool-call {
        margin-top: 16px;
        margin-bottom: 16px;
        border: 1px solid var(--border-tool);
        border-radius: 6px;
        overflow: hidden;
        font-size: var(--font-size-base);
        /* Ensure background color to avoid gaps being transparent */
        background: var(--bg-tool);
        --mask-bg: var(--bg-tool);
        box-shadow: var(--shadow-sm);
      }

      .tool-header {
        padding: 8px 12px;
        background: var(--bg-tool);
        /* border-bottom removed to unify look */
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-family: var(--font-mono);
      }

      .tool-name {
        font-weight: var(--font-weight-bold);
        font-family: var(--font-sans);
        color: var(--tool-color);
        text-transform: lowercase;
      }
      .tool-id {
        color: var(--tool-color);
        font-size: var(--font-size-sm);
      }

      .tool-header-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .timestamp {
        font-family: var(--font-mono);
        font-size: var(--font-size-sm);
        color: var(--text-dim);
        margin-left: auto;
        font-weight: normal;
      }

      .assistant-toolbar .timestamp {
        margin-right: 8px;
      }

      .tool-args {
        padding: 12px;
        background: var(--bg-tool-args);
        font-family: var(--font-mono);
        color: var(--tool-color);
        overflow-x: auto;
        white-space: pre-wrap;
        font-size: var(--font-size-sm);
      }

      /* Collapsible tool-args */
      details.tool-args-collapsible {
        background: var(--bg-tool-args);
        margin: 6px 12px;
        border: 1px solid var(--border-tool);
        border-radius: 6px;
        overflow: hidden;
      }
      details.tool-args-collapsible > summary {
        padding: 6px 10px;
        font-family: var(--font-mono);
        font-size: var(--font-size-sm);
        text-transform: lowercase;
        font-weight: var(--font-weight-bold);
        cursor: pointer;
        user-select: none;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--tool-color);
        transition: color 0.2s;
        border-radius: 6px;
      }
      details.tool-args-collapsible > summary:hover,
      details.tool-args-collapsible[open] > summary {
        color: var(--tool-color);
      }
      details.tool-args-collapsible[open] > summary {
        border-bottom: 1px solid var(--border-tool);
        border-bottom-left-radius: 6px;
        border-bottom-right-radius: 6px;
      }
      details.tool-args-collapsible > summary::-webkit-details-marker {
        display: none;
      }
      details.tool-args-collapsible > summary::before {
        content: "▶";
        font-size: 0.8em;
        
        color: var(--tool-color);
        font-family: var(--font-mono);
        display: inline-block;
        width: 16px;
        text-align: center;
      }
      details.tool-args-collapsible[open] > summary::before {
        content: "▼";
      }
      details.tool-args-collapsible > .tool-args-content {
        padding: 10px;
        font-family: var(--font-mono);
        color: var(--tool-color);
        overflow-x: auto;
        white-space: pre-wrap;
        font-size: var(--font-size-sm);
        background: var(--bg-tool-args);
        /* border-top handled by summary bottom border when open */
      }

      .tool-result {
        /* border-top removed to unify look */
        padding: 12px;
        font-size: var(--font-size-sm);
      }
      .tool-result .full-text,
      .tool-result .preview-text,
      .tool-result pre,
      .tool-result code {
        font-size: var(--font-size-sm);
      }

      .tool-result.success {
        background: var(--bg-tool);
        color: var(--tool-color);
        --mask-bg: var(--bg-tool);
      }
      .tool-result.error {
        background: var(--bg-error);
        color: var(--error);
        --mask-bg: var(--bg-error);
      }
      .tool-result.pending {
        background: var(--bg-tool);
        color: var(--tool-color);
        --mask-bg: var(--bg-tool);
      }

      /* Tool Output Collapsing */
      .expandable-tool-output {
        position: relative;
        display: block;
      }
      .tool-output-preview {
        position: relative;
        max-height: 200px;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }
      .tool-output-preview.expanded {
        max-height: none;
        overflow: visible;
      }
      .tool-output-preview:not(.expanded)::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: linear-gradient(to bottom, transparent 0%, var(--mask-bg, var(--bg-card)) 100%);
        pointer-events: none;
      }
      .tool-output-preview.expanded + .expand-control {
        display: none;
      }

      /* Sub-Agent Result */
      .sub-agent-result-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 8px;
      }

      .sub-agent-toolbar {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-bottom: 4px;
      }

      .sub-agent-content {
        width: 100%;
      }

      .sub-agent-raw {
        display: none;
        font-family: var(--font-mono);
        font-size: var(--font-size-base);
        white-space: pre-wrap;
        background: var(--bg-code);
        border: 1px dashed var(--border);
        border-radius: 6px;
        padding: 12px 16px;
      }

      .sub-agent-content.show-raw .sub-agent-rendered {
        display: none;
      }
      .sub-agent-content.show-raw .sub-agent-raw {
        display: block;
      }

      .sub-agent-rendered h1 {
        font-size: 1.5em;
        border-bottom: 1px solid var(--border);
        padding-bottom: 0.3em;
        margin-bottom: 16px;
      }

      /* Collapsible Markdown Headings */
      .markdown-body details {
        margin-top: 1em;
        margin-bottom: 1em;
      }
      .markdown-body details > summary {
        cursor: pointer;
        list-style: none; /* Modern browsers */
        position: relative;
        padding-left: 1.5em; /* Space for triangle */
        display: flex;
        align-items: baseline;
        gap: 8px;
        margin-top: 24px;
        margin-bottom: 16px;
      }
      .markdown-body details > summary::-webkit-details-marker {
        display: none;
      }
      /* Triangle indicator */
      .markdown-body details > summary::before {
        content: "▶";
        position: absolute;
        left: 0;
        /* Center vertically relative to line-height */
        top: 0.2em;
        font-size: 0.8em;
        color: var(--text-dim);
        transition: transform 0.2s;
        line-height: inherit;
        flex-shrink: 0;
      }
      .markdown-body details[open] > summary::before {
        transform: rotate(90deg);
      }

      /* Indent content to align with triangle */
      .markdown-body details > *:not(summary) {
        margin-left: 1.5em;
      }

      /* Reset margins for headings inside summary to avoid double spacing */
      .markdown-body details > summary > h2,
      .markdown-body details > summary > h3,
      .markdown-body details > summary > h4,
      .markdown-body details > summary > h5,
      .markdown-body details > summary > h6 {
        margin-top: 0;
        margin-bottom: 0;
        flex-grow: 1;
        width: 100%;
      }

      /* Markdown Elements */
      .markdown-body {
        font-family: var(--font-markdown);
        line-height: 1.4;
        font-size: var(--font-size-base);
      }
      .markdown-body > *:first-child {
        margin-top: 0 !important;
      }
      .markdown-body > *:last-child {
        margin-bottom: 0 !important;
      }
      
      .markdown-body h1,
      .markdown-body h2,
      .markdown-body h3,
      .markdown-body h4,
      .markdown-body h5,
      .markdown-body h6 {
        margin-top: 24px;
        margin-bottom: 16px;
        font-weight: var(--font-weight-bold);
        line-height: 1.25;
      }

      .markdown-body h1 {
        font-size: 1.75em;
        background: var(--bg-container);
        padding: 6px 12px;
        border-radius: 6px;
        display: inline-block;
      }

      .markdown-body h2 {
        font-size: 1.35em;
        padding-bottom: 0.2em;
        border-bottom: 1px solid var(--border);
      }

      .markdown-body h3 {
        font-size: 1.15em;
      }

      .markdown-body h4 {
        font-size: 1em;
      }

      .markdown-body h5 {
        font-size: 0.9em;
      }

      .markdown-body h6 {
        font-size: 0.85em;
        color: var(--text-dim);
      }

      .markdown-body a {
        color: var(--accent);
        text-decoration: none;
        border-bottom: 1px solid var(--accent-underline);
        transition: border-color 0.2s, background-color 0.2s;
      }
      .markdown-body a:hover {
        border-bottom-color: var(--accent);
        background-color: var(--accent-hover);
        border-radius: 6px;
      }

      .markdown-body p {
        margin-bottom: 8px; /* Tighter spacing */
      }
      
      .markdown-body ul,
      .markdown-body ol {
        margin-bottom: 8px; /* Tighter spacing */
        padding-left: 1.5rem;
        list-style-position: outside;
      }
      
      .markdown-body ul ul,
      .markdown-body ol ul,
      .markdown-body ul ol,
      .markdown-body ol ol {
        margin-top: 0;
        margin-bottom: 0;
      }
      
      .markdown-body li > p {
        margin-bottom: 0;
      }
      .markdown-body li + li {
        margin-top: 0.25em;
      }

      .markdown-body blockquote {
        margin: 0 0 16px;
        padding: 0 1em;
        color: var(--text-dim);
        border-left: 0.25em solid var(--border);
      }

      .markdown-body table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 8px;
        margin-bottom: 16px;
        display: block;
        overflow-x: auto;
      }
      
      .markdown-body table tr {
        border-top: 1px solid var(--border);
      }
      
      .markdown-body table tr:nth-child(2n) {
        background-color: transparent;
      }
      
      .markdown-body table th,
      .markdown-body table td {
        padding: 6px 13px;
        border: 1px solid var(--border);
      }
      
      .markdown-body table th {
        font-weight: var(--font-weight-bold);
        background-color: transparent;
        color: var(--text-dim);
      }

      .markdown-body table th code,
      .markdown-body table td code {
        background-color: transparent;
      }

      .markdown-body hr {
        height: 0;
        margin: 24px 0;
        border: none;
        border-top: 1px solid var(--border);
      }
      .markdown-body pre {
        background: var(--bg-code);
        padding: 12px;
        border-radius: 6px;
        overflow-x: auto;
        margin: 8px 0 16px 0;
        border: 1px solid var(--border);
      }
      .markdown-body code {
        font-family: var(--font-markdown-mono);
        color: var(--fg-inline-code);
        font-size: 85%;
        padding: 2px 4px;
        border-radius: 6px;
        background-color: var(--bg-code); /* Slight bg for inline code */
      }
      .markdown-body pre code {
        background: transparent;
        padding: 0;
        border-radius: 6px;
        color: inherit;
      }
      .markdown-body pre code.hljs {
        background: transparent;
      }

      /* Diff View */
      .diff-view {
        font-family: var(--font-mono);
        background: var(--bg-code);
        padding: 12px;
        border-radius: 6px;
        overflow-x: auto;
        border: 1px solid var(--border);
      }
      .diff-file {
        color: var(--accent);
        font-weight: 700;
        margin: 6px 0 4px 0;
        font-size: var(--font-size-sm);
      }
      .diff-stats {
        font-weight: 700;
      }
      .diff-stats-add {
        color: var(--success);
      }
      .diff-stats-remove {
        color: var(--error);
      }
      .diff-line {
        white-space: pre;
      }
      .diff-plus {
        color: var(--success);
        background: var(--bg-success);
        display: block;
      }
      .diff-minus {
        color: var(--error);
        background: var(--bg-error);
        display: block;
      }
      .diff-ctx {
        color: var(--text-dim);
        opacity: 0.7;
        display: block;
      }
      .diff-span {
        white-space: pre;
      }
      .diff-char-add {
        background: var(--bg-success-strong);
        font-weight: 700;
      }
      .diff-char-remove {
        background: var(--bg-error-strong);
        font-weight: 700;
      }

      /* Collapsible Diff View */
      details.diff-collapsible {
        background: transparent;
        margin-top: 8px;
      }
      details.diff-collapsible > summary {
        padding: 4px 0;
        font-family: var(--font-mono);
        font-size: var(--font-size-sm);
        text-transform: lowercase;
        font-weight: var(--font-weight-bold);
        cursor: pointer;
        user-select: none;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-dim);
        transition: color 0.2s;
      }
      details.diff-collapsible > summary:hover,
      details.diff-collapsible[open] > summary {
        color: var(--text);
      }
      details.diff-collapsible > summary::-webkit-details-marker {
        display: none;
      }
      details.diff-collapsible > summary::before {
        content: "▶";
        font-size: 0.8em;
        
        color: var(--accent);
        font-family: var(--font-mono);
        display: inline-block;
        width: 16px;
        text-align: center;
      }
      details.diff-collapsible[open] > summary::before {
        content: "▼";
      }
      details.diff-collapsible > .diff-view {
        margin-top: 8px;
      }

      .footer {
        margin-top: 60px;
        text-align: center;
        color: var(--text-dim);
        font-size: var(--font-size-sm);
        border-top: 1px solid var(--border);
        padding-top: 24px;
      }

      .footer-link {
        color: inherit;
        text-decoration: none;
        font-weight: 700;
        transition: color 0.2s;
      }

      .footer-link:hover {
        color: var(--accent);
      }

      .expandable {
        cursor: pointer;
      }
      .expandable.expanded {
        cursor: auto;
      }

      .expandable-output {
        /* Default fallback; per-block override comes from inline style in export.py */
        --preview-max-lines: 8;
      }
      .expandable-output .preview-text {
        line-height: 1.45;
      }
      .expandable-output:not(.expanded) .preview-text {
        max-height: calc(var(--preview-max-lines) * 1.45em);
        overflow: hidden;
      }

      .expandable .full-text {
        display: none;
      }
      .expandable .collapse-hint {
        display: none;
      }
      .expandable.expanded .preview-text {
        display: none;
      }
      .expandable.expanded .expand-hint {
        display: none;
      }
      .expandable.expanded .full-text {
        display: block;
      }
      .expandable.expanded .collapse-hint {
        display: block;
        cursor: pointer;
        color: var(--accent);
        font-size: var(--font-size-sm);
        margin-top: 4px;
        border-top: 1px dashed var(--border);
        padding-top: 4px;
      }
      .expand-hint {
        font-size: var(--font-size-sm);
        color: var(--accent);
        margin-top: 4px;
      }

      /* Todo List */
      .todo-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .todo-item {
        display: flex;
        gap: 8px;
        font-family: var(--font-mono);
        font-size: var(--font-size-sm);
        line-height: 1.5;
        align-items: flex-start;
      }
      .todo-bullet {
        flex-shrink: 0;
        font-size: 16px;
        line-height: 1.5;
        opacity: 0.7;
      }
      .todo-item.status-completed {
        color: var(--text-dim);
        text-decoration: line-through;
      }
      .todo-item.status-in_progress {
        color: var(--success);
        font-weight: 500;
      }
      .todo-item.status-pending {
        color: var(--text-dim);
      }

      /* Sub-agent Session */
      details.sub-agent-session {
        background: var(--bg-card);
        margin: 16px 0;
        border: 1px solid var(--border);
        border-left: 3px solid var(--accent);
        border-radius: 6px;
        overflow: hidden;
      }
      details.sub-agent-session > summary {
        padding: 10px 14px;
        font-family: var(--font-mono);
        font-size: var(--font-size-sm);
        text-transform: lowercase;
        font-weight: var(--font-weight-bold);
        cursor: pointer;
        user-select: none;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 8px;
        min-height: 24px;
        line-height: 1.2;
        color: var(--text-dim);
        transition: color 0.2s;
        background: var(--bg-container);
      }
      details.sub-agent-session > summary:hover,
      details.sub-agent-session[open] > summary {
        color: var(--text);
      }
      details.sub-agent-session > summary::-webkit-details-marker {
        display: none;
      }
      details.sub-agent-session > summary::before {
        content: "▶";
        font-size: 0.8em;
        
        color: var(--accent);
        font-family: var(--font-mono);
        margin-right: 4px;
        display: inline-block;
        width: 16px;
        text-align: center;
      }
      details.sub-agent-session[open] > summary::before {
        content: "▼";
      }
      details.sub-agent-session > .sub-agent-content {
        padding: 12px 16px 16px 16px;
        border-top: 1px solid var(--border);
      }

      /* Scroll to Bottom Button */
      .scroll-btn {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 40px;
        height: 40px;
        border-radius: 6px;
        background: var(--bg-card);
        border: 1px solid var(--border);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        color: var(--text-dim);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 100;
      }

      .scroll-btn:hover {
        color: var(--accent);
        border-color: var(--accent);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
      }

      .scroll-btn.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      /* Tool details in Available Tools section */
      .tool-details {
        margin-bottom: 4px;
        border-radius: 6px;
        transition: all 0.2s;
        overflow: hidden;
      }
      .tool-details[open] {
        background: var(--bg-tool);
        margin-bottom: 12px;
        border: 1px solid var(--border-tool);
      }
      .tool-details summary {
        color: var(--tool-color);
        font-weight: 500;
        text-transform: none;
        letter-spacing: normal;
        cursor: pointer;
        user-select: none;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 8px;
        border-radius: 6px;
        transition: background-color 0.2s;
      }
      .tool-details:not([open]) summary:hover {
        background: var(--bg-tool-args);
      }
      .tool-details summary::-webkit-details-marker {
        display: none;
      }
      .tool-details summary:hover {
        color: var(--tool-color);
      }
      .tool-details summary::before {
        content: "▶";
        font-size: 0.8em;
        
        width: 16px;
        text-align: center;
        display: inline-block;
      }
      .tool-details[open] summary::before {
        content: "▼";
      }
      .tool-details .details-content {
        padding: 8px 16px 16px 32px;
        color: var(--text);
        border-top: 1px solid var(--border-tool);
      }
      .tool-description {
        white-space: pre-wrap;
        font-size: var(--font-size-sm);
        color: var(--text-dim);
      }
      .tool-params {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px dashed var(--border-tool);
      }
      .tool-params-title {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-bold);
        text-transform: lowercase;
        color: var(--text-dim);
        margin-bottom: 8px;
      }
      .tool-param {
        margin-bottom: 8px;
        padding-left: 12px;
        font-size: var(--font-size-sm);
      }
      .tool-param-name {
        color: var(--tool-color);
        font-weight: 500;
      }
      .tool-param-type {
        color: var(--text-dim);
      }
      .tool-param-required {
        color: var(--error);
        margin-left: 4px;
      }
      .tool-param-desc {
        color: var(--text-dim);
        font-size: var(--font-size-sm);
        margin-top: 2px;
      }
      /* TOC Sidebar */
      .toc-sidebar {
        position: fixed;
        top: 20vh;
        left: 12px;
        width: 180px;
        bottom: 20vh;
        overflow-y: auto;
        padding-right: 8px;
        /* Vertical padding to offset mask */
        padding-top: 30px;
        padding-bottom: 30px;
        display: none;
        scrollbar-width: none;
        z-index: 100;
        /* Linear mask for fading edges */
        -webkit-mask-image: linear-gradient(
          to bottom,
          transparent 0%,
          black 30px,
          black calc(100% - 30px),
          transparent 100%
        );
        mask-image: linear-gradient(
          to bottom,
          transparent 0%,
          black 30px,
          black calc(100% - 30px),
          transparent 100%
        );
      }

      .toc-sidebar::-webkit-scrollbar {
        display: none;
      }

      /* Show TOC on wide screens */
      @media (min-width: 1400px) {
        .toc-sidebar {
          display: block;
        }
      }

      .toc-item {
        display: block;
        padding: 3px 10px;
        margin-bottom: 1px;
        font-family: var(--font-mono);
        font-size: 12px;
        line-height: 1.4;
        color: var(--text-dim);
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border-radius: 6px;
      }

      .toc-item:hover {
        color: var(--text);
        background: rgba(0, 0, 0, 0.03);
      }

      .toc-item.active {
        color: var(--text);
        background: var(--bg-card);
        font-weight: bold;
        box-shadow: var(--shadow-sm);
        color: var(--accent);
      }

      .toc-item.toc-user {
        border-left: 2px solid var(--accent);
        padding-left: 8px;
      }

      .toc-item.toc-assistant {
        border-left: 2px solid var(--assistant-border);
        padding-left: 8px;
        font-size: 12px;
        opacity: 0.7;
      }

      /* Header Controls */
      .header-controls {
        margin-top: 16px;
        display: flex;
        justify-content: flex-end;
      }
      
      .verbose-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 4px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
        font-family: var(--font-mono);
        font-size: var(--font-size-sm);
        color: var(--text-dim);
        background: var(--bg-card);
        transition: all 0.2s ease;
        user-select: none;
      }

      .verbose-btn:hover {
        color: var(--text);
        border-color: var(--accent);
      }

      .verbose-btn.active {
        background: var(--accent-dim);
        color: var(--accent);
        border-color: var(--accent);
      }

      .verbose-btn input {
        display: none;
      }

      .verbose-icon {
        font-family: var(--font-mono);
        font-weight: bold;
        /* Revert display/box properties from checkmark style */
        display: inline;
        width: auto;
        height: auto;
        border: none;
        border-radius: 6px;
        position: static;
        transition: none;
      }
      
      /* Remove checkmark styles */
      .verbose-btn.active .verbose-icon {
        background: transparent;
        border-color: transparent;
      }
      .verbose-btn.active .verbose-icon::after {
        content: none;
      }

      /* Verbose Mode Visibility Logic */
      body:not(.verbose-mode) .thinking-block,
      body:not(.verbose-mode) details.developer-message,
      body:not(.verbose-mode) .response-metadata {
        display: none !important;
      }

      .turn-collapsible {
        margin: 16px 0;
      }

      .turn-collapse-btn {
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--bg-card);
        color: var(--text-dim);
        font-family: var(--font-mono);
        font-size: var(--font-size-sm);
        padding: 4px 12px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
      }

      .turn-collapse-btn:hover {
        color: var(--text);
        border-color: var(--accent);
      }

      .turn-collapse-btn.expanded {
        color: var(--accent);
        border-color: var(--accent);
        background: var(--accent-dim);
      }

      .turn-steps {
        margin-top: 8px;
        padding-left: 16px;
        border-left: 2px solid var(--border);
      }

      /* Collapsible Markdown (Sub-agent) */
      .expandable-markdown {
        position: relative;
        display: block;
      }
      .markdown-preview {
        position: relative;
        max-height: 300px;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }
      .markdown-preview.expanded {
        max-height: none;
        overflow: visible;
      }
      /* Mask for preview state */
      .markdown-preview:not(.expanded)::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: linear-gradient(to bottom, transparent 0%, var(--mask-bg, var(--bg-card)) 100%);
        pointer-events: none;
      }

      .expand-control {
        display: flex;
        justify-content: center;
        margin-top: -20px; /* Pull button up into mask area */
        position: relative;
        z-index: 10;
        padding-bottom: 8px;
      }
      .markdown-preview.expanded + .expand-control {
        display: none;
      }

      .expand-btn {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 4px 16px;
        font-size: var(--font-size-sm);
        color: var(--accent);
        cursor: pointer;
        font-family: var(--font-mono);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.2s;
      }
      .expand-btn:hover {
        border-color: var(--accent);
        color: var(--text);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }

      /* Mask for Tool Output */
      .expandable-output {
        position: relative;
      }
      .expandable-output:not(.expanded) .preview-text {
        /* Add mask to the text container itself */
        -webkit-mask-image: linear-gradient(to bottom, black calc(100% - 24px), transparent 100%);
        mask-image: linear-gradient(to bottom, black calc(100% - 24px), transparent 100%);
      }
    </style>
  </head>
  <body>
    <div id="toc-sidebar" class="toc-sidebar"></div>
    <div class="container">
      <div class="header">
        <h1>Klaude Code</h1>
        <div class="meta-grid">
          <div class="meta-item">
            <span class="meta-label">Model</span>
            <span class="meta-value">$model_name</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Updated</span>
            <span class="meta-value">$session_updated</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Directory</span>
            <span class="meta-value" title="$work_dir_full">$work_dir</span>
          </div>
        </div>
        <div class="header-controls">
          <label class="verbose-btn" id="verbose-label">
            <input type="checkbox" id="verbose-toggle" />
            <span class="verbose-icon">▶</span>
            <span class="verbose-text">Verbose</span>
          </label>
        </div>
      </div>

      <details class="collapsible-section">
        <summary>system prompt</summary>
        <div
          class="details-content system-prompt-content"
          style="font-family: var(--font-mono); white-space: pre-wrap"
        >
          $system_prompt
        </div>
      </details>

      <details class="collapsible-section">
        <summary>available tools</summary>
        <div class="details-content">$tools_html</div>
      </details>

      <div class="message-stream">$messages_html</div>

      <div class="footer">
        Generated by
        <a
          href="https://github.com/inspirepan/klaude-code"
          class="footer-link"
          target="_blank"
          >klaude-code</a
        >
        &bull; $footer_time &bull; $total_messages messages
      </div>
    </div>

    <div id="scroll-btn" class="scroll-btn" title="Scroll to bottom">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <polyline points="19 12 12 19 5 12"></polyline>
      </svg>
    </div>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github.min.css"
    />
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
      // Trim whitespace from pre-wrap content to avoid formatting artifacts
      document.querySelectorAll(".system-prompt-content").forEach((el) => {
        el.textContent = el.textContent.trim();
      });

      // Process markdown for collapsible sections
      // foldH2: if true, H2 headers start collapsed; otherwise all headers start open
      function structureMarkdown(root, foldH2 = false) {
        // Find all headings
        const headers = Array.from(root.querySelectorAll("h1, h2, h3, h4, h5, h6"));
        if (!headers.length) return;

        const stack = [{ element: root, level: 0 }];
        const children = Array.from(root.childNodes);
        
        root.innerHTML = '';

        children.forEach(node => {
          let level = 100; // Content level
          if (node.tagName && /^H[1-6]$$/.test(node.tagName)) {
            level = parseInt(node.tagName.substring(1));
          }

          if (level === 1) {
            // H1: not collapsible, just append directly
            while (stack.length > 1) {
              stack.pop();
            }
            stack[0].element.appendChild(node);

          } else if (level >= 2 && level < 100) {
            // H2-H6: collapsible
            // Close any open sections that are deeper or same level
            while (stack.length > 1 && stack[stack.length - 1].level >= level) {
              stack.pop();
            }

            // Create new section
            const details = document.createElement('details');
            const summary = document.createElement('summary');
            
            // Move header into summary
            summary.appendChild(node);
            details.appendChild(summary);

            // Default open state: fold H2 only if foldH2 is true
            if (!(foldH2 && level === 2)) {
              details.setAttribute('open', '');
            }

            // Append this details to the current parent in stack
            stack[stack.length - 1].element.appendChild(details);
            
            // Push to stack as the new current container
            stack.push({ element: details, level: level });

          } else {
            // Content node (p, ul, text, etc)
            // Append to current container
            stack[stack.length - 1].element.appendChild(node);
          }
        });
      }

      // Markdown rendering and Syntax Highlighting
      document.querySelectorAll(".markdown-content").forEach((el) => {
        const raw = el.dataset.raw;
        if (raw && window.marked) {
          // 1. Render Markdown
          el.innerHTML = window.marked.parse(raw);

          // 2. Apply Syntax Highlighting
          if (window.hljs) {
            el.querySelectorAll("pre code").forEach((block) => {
              hljs.highlightElement(block);
            });
          }

          // 3. Make headings collapsible
          // Sub-agent results: fold H2 by default; others: all open
          const foldH2 = el.classList.contains("sub-agent-rendered");
          structureMarkdown(el, foldH2);
        }
      });

      // Expandable tool outputs
      document.querySelectorAll(".expandable").forEach((el) => {
        el.addEventListener("click", (e) => {
          if (!el.classList.contains("expanded")) {
            el.classList.add("expanded");
          } else if (e.target.classList.contains("collapse-hint")) {
            el.classList.remove("expanded");
          }
        });
      });

      // Assistant raw toggle
      document.querySelectorAll(".assistant-message-group").forEach((group) => {
        const toggle = group.querySelector(".raw-toggle");
        const copyBtn = group.querySelector(".copy-raw-btn");
        const block = group.querySelector(".assistant-message");
        const rendered = block
          ? block.querySelector(".assistant-rendered")
          : null;
        const raw = block ? block.querySelector(".assistant-raw") : null;

        // Copy button logic
        if (copyBtn && rendered) {
          copyBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            const rawContent = rendered.dataset.raw;
            if (!rawContent) return;

            try {
              // Decode HTML entities for copy
              const textarea = document.createElement("textarea");
              textarea.innerHTML = rawContent;
              const decoded = textarea.value;

              await navigator.clipboard.writeText(decoded);

              // Visual feedback
              const originalText = copyBtn.textContent;
              copyBtn.textContent = "Copied!";
              copyBtn.style.color = "var(--success)";
              copyBtn.style.borderColor = "var(--success)";

              setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.style.color = "";
                copyBtn.style.borderColor = "";
              }, 2000);
            } catch (err) {
              console.error("Failed to copy:", err);
              copyBtn.textContent = "Error";
              copyBtn.style.color = "var(--error)";
              setTimeout(() => {
                copyBtn.textContent = "Copy";
                copyBtn.style.color = "";
              }, 2000);
            }
          });
        }

        if (!toggle || !rendered || !raw) {
          return;
        }

        const setState = (showRaw) => {
          block.classList.toggle("show-raw", showRaw);
          toggle.classList.toggle("active", showRaw);
          toggle.setAttribute("aria-pressed", String(showRaw));
          toggle.textContent = showRaw ? "Markdown" : "Raw";
        };

        toggle.addEventListener("click", (event) => {
          event.stopPropagation();
          const nextState = !block.classList.contains("show-raw");
          setState(nextState);
        });
      });

      // Sub-agent raw toggle
      document
        .querySelectorAll(".sub-agent-result-container")
        .forEach((group) => {
          const toggle = group.querySelector(".raw-toggle");
          const copyBtn = group.querySelector(".copy-raw-btn");
          const block = group.querySelector(".sub-agent-content");
          const rendered = block
            ? block.querySelector(".sub-agent-rendered")
            : null;
          const raw = block ? block.querySelector(".sub-agent-raw") : null;

          // Copy button logic
          if (copyBtn && rendered) {
            copyBtn.addEventListener("click", async (e) => {
              e.stopPropagation();
              const rawContent = rendered.dataset.raw;
              if (!rawContent) return;

              try {
                const textarea = document.createElement("textarea");
                textarea.innerHTML = rawContent;
                const decoded = textarea.value;

                await navigator.clipboard.writeText(decoded);

                const originalText = copyBtn.textContent;
                copyBtn.textContent = "Copied!";
                copyBtn.style.color = "var(--success)";
                copyBtn.style.borderColor = "var(--success)";

                setTimeout(() => {
                  copyBtn.textContent = originalText;
                  copyBtn.style.color = "";
                  copyBtn.style.borderColor = "";
                }, 2000);
              } catch (err) {
                console.error("Failed to copy:", err);
                copyBtn.textContent = "Error";
                copyBtn.style.color = "var(--error)";
                setTimeout(() => {
                  copyBtn.textContent = "Copy";
                  copyBtn.style.color = "";
                }, 2000);
              }
            });
          }

          if (!toggle || !rendered || !raw) {
            return;
          }

          const setState = (showRaw) => {
            block.classList.toggle("show-raw", showRaw);
            toggle.classList.toggle("active", showRaw);
            toggle.setAttribute("aria-pressed", String(showRaw));
            toggle.textContent = showRaw ? "Markdown" : "Raw";
          };

          toggle.addEventListener("click", (event) => {
            event.stopPropagation();
            const nextState = !block.classList.contains("show-raw");
            setState(nextState);
          });
        });

      // Scroll to bottom button
      const scrollBtn = document.getElementById("scroll-btn");

      function updateScrollBtn() {
        // Show button if we are not at the bottom
        const isAtBottom =
          window.innerHeight + window.scrollY >=
          document.body.offsetHeight - 100;
        if (isAtBottom) {
          scrollBtn.classList.remove("visible");
        } else {
          scrollBtn.classList.add("visible");
        }
      }

      window.addEventListener("scroll", updateScrollBtn);
      window.addEventListener("resize", updateScrollBtn);
      updateScrollBtn(); // Initial check

      scrollBtn.addEventListener("click", () => {
        window.scrollTo({
          top: document.body.scrollHeight,
          behavior: "smooth",
        });
      });

      // TOC Logic
      document.addEventListener("DOMContentLoaded", () => {
        const tocSidebar = document.getElementById("toc-sidebar");
        if (!tocSidebar) return;

        const sections = [];
        let userCount = 0;
        let assistantCount = 0;

        // 1. System Prompt
        const sysPrompt = document.querySelector(
          ".collapsible-section summary"
        );
        if (sysPrompt && sysPrompt.textContent.includes("system prompt")) {
          const details = sysPrompt.parentElement;
          details.id = details.id || "section-system-prompt";
          sections.push({
            id: details.id,
            label: "system prompt",
            el: details,
          });
        }

        // 2. Messages and Tools
        const stream = document.querySelector(".message-stream");
        if (stream) {
          // Use a Walker to find top-level relevant items if structure is complex
          // But assuming flat children of message-stream based on CSS
          Array.from(stream.children).forEach((child) => {
            let label = null;
            let idPrefix = "section";

            if (child.classList.contains("message-group")) {
              const roleLabel = child.querySelector(".role-label");
              if (roleLabel) {
                if (roleLabel.classList.contains("user")) {
                  userCount++;
                  const contentEl = child.querySelector('.message-content.user');
                  let preview = '';
                  if (contentEl) {
                    preview = contentEl.textContent.trim().replace(/\s+/g, ' ').substring(0, 80);
                  }
                  label = preview || `user $${userCount}`;
                  idPrefix = "user";
                } else if (roleLabel.classList.contains("assistant")) {
                  assistantCount++;
                  const contentEl = child.querySelector('.assistant-rendered');
                  let preview = '';
                  if (contentEl) {
                    preview = contentEl.textContent.trim().replace(/\s+/g, ' ').substring(0, 80);
                  }
                  label = preview || `assistant $${assistantCount}`;
                  idPrefix = "assistant";
                } else {
                  label = roleLabel.textContent.trim();
                }
              }
            } else if (child.classList.contains("tool-call")) {
              const toolName = child.querySelector(".tool-name");
              if (toolName) {
                label = toolName.textContent.trim();
                idPrefix = "tool";

                // Try to extract description for Sub Agents
                try {
                  const argsContent = child.querySelector(".tool-args-content");
                  if (argsContent) {
                    const argsText = argsContent.textContent.trim();
                    if (argsText.startsWith("{")) {
                      const args = JSON.parse(argsText);
                      if (
                        args &&
                        typeof args.description === "string" &&
                        args.description.trim()
                      ) {
                        let desc = args.description.trim();
                        if (desc.length > 30) {
                          desc = desc.substring(0, 30) + "…";
                        }
                        label = label + " - " + desc;
                      }
                    }
                  }
                } catch (e) {
                  // Ignore JSON parse errors
                }
              } else {
                label = "Tool";
              }
            }

            if (label) {
              child.id =
                child.id ||
                `$$$${idPrefix}-$$$${Math.random().toString(36).substr(2, 9)}`;
              sections.push({ id: child.id, label: label, el: child, type: idPrefix });
            }
          });
        }

        // Render TOC
        sections.forEach((section) => {
          const item = document.createElement("div");
          item.className = "toc-item" + (section.type === "user" ? " toc-user" : section.type === "assistant" ? " toc-assistant" : "");
          item.textContent = section.label;
          item.dataset.target = section.id;
          item.addEventListener("click", () => {
            section.el.scrollIntoView({ behavior: "smooth", block: "start" });
          });
          tocSidebar.appendChild(item);
        });

        // Scroll Spy with throttling
        let ticking = false;
        const offset = 150; // Pixel offset for "active" area

        function updateActiveSection() {
          let currentId = sections.length > 0 ? sections[0].id : null;
          const scrollY = window.scrollY;

          // We look for the last section that has passed the top threshold (+ offset)
          for (let i = 0; i < sections.length; i++) {
            const el = sections[i].el;
            // If element top is above the "active line" (scrollY + offset)
            if (el.offsetTop <= scrollY + offset) {
              currentId = sections[i].id;
            } else {
              // Since sections are ordered by position, we can stop once we find one below the line
              break;
            }
          }

          // Update UI
          document.querySelectorAll(".toc-item").forEach((item) => {
            const isActive = item.dataset.target === currentId;
            if (item.classList.contains("active") !== isActive) {
              item.classList.toggle("active", isActive);
              if (isActive) {
                // Auto-scroll sidebar to visible
                const sidebarRect = tocSidebar.getBoundingClientRect();
                const itemRect = item.getBoundingClientRect();
                // Check if item is out of view in sidebar (accounting for mask)
                if (
                  itemRect.top < sidebarRect.top + 40 ||
                  itemRect.bottom > sidebarRect.bottom - 40
                ) {
                  item.scrollIntoView({ behavior: "smooth", block: "center" });
                }
              }
            }
          });

          ticking = false;
        }

        window.addEventListener("scroll", () => {
          if (!ticking) {
            window.requestAnimationFrame(updateActiveSection);
            ticking = true;
          }
        });

        // Initial update
        updateActiveSection();
      });

      // Turn collapsing
      document.querySelectorAll('.turn-collapse-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const container = btn.parentElement;
          const steps = container.querySelector('.turn-steps');
          const isHidden = steps.style.display === 'none';
          
          steps.style.display = isHidden ? 'block' : 'none';
          btn.classList.toggle('expanded', isHidden);
          
          const icon = btn.querySelector('.collapse-icon');
          if (icon) icon.textContent = isHidden ? '▼' : '▶';
        });
      });

      // Expandable content (Sub-agent markdown & Tool output)
      document.body.addEventListener('click', (e) => {
        if (e.target.classList.contains('expand-btn')) {
          const container = e.target.closest('.expandable-markdown, .expandable-tool-output');
          if (container) {
            const preview = container.querySelector('.markdown-preview, .tool-output-preview');
            if (preview) {
              preview.classList.add('expanded');
            }
          }
        }
      });

      // Verbose Toggle
      const verboseToggle = document.getElementById('verbose-toggle');
      const verboseLabel = document.getElementById('verbose-label');
      let isVerbose = false;

      function updateVerboseUI() {
        const icon = verboseLabel ? verboseLabel.querySelector('.verbose-icon') : null;
        
        if (isVerbose) {
          document.body.classList.add('verbose-mode');
          if (verboseLabel) verboseLabel.classList.add('active');
          if (icon) icon.textContent = '▼';
          document.querySelectorAll('.turn-collapse-btn').forEach(btn => {
            const container = btn.parentElement;
            const steps = container ? container.querySelector('.turn-steps') : null;
            if (!steps) return;
            steps.style.display = 'block';
            btn.classList.add('expanded');
            const collapseIcon = btn.querySelector('.collapse-icon');
            if (collapseIcon) collapseIcon.textContent = '▼';
          });
        } else {
          document.body.classList.remove('verbose-mode');
          if (verboseLabel) verboseLabel.classList.remove('active');
          if (icon) icon.textContent = '▶';
          document.querySelectorAll('.turn-collapse-btn').forEach(btn => {
            const container = btn.parentElement;
            const steps = container ? container.querySelector('.turn-steps') : null;
            if (!steps) return;
            steps.style.display = 'none';
            btn.classList.remove('expanded');
            const collapseIcon = btn.querySelector('.collapse-icon');
            if (collapseIcon) collapseIcon.textContent = '▶';
          });
          // Enforce collapsing of details when switching to non-verbose
          document.querySelectorAll('details.tool-args-collapsible, details.diff-collapsible, details.sub-agent-session').forEach(el => {
            el.removeAttribute('open');
          });
        }
      }

      if (verboseToggle) {
        verboseToggle.addEventListener('change', (e) => {
          isVerbose = e.target.checked;
          updateVerboseUI();
        });
        
        // Initialize state (default false)
        // Also force close any initially open details if non-verbose
        if (!isVerbose) {
           document.querySelectorAll('details.tool-args-collapsible, details.diff-collapsible, details.sub-agent-session').forEach(el => {
            el.removeAttribute('open');
          });
        }
      }
    </script>
  </body>
</html>
